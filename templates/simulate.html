<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/simulate.css">
    <link rel="stylesheet" href="../static/css/navbar.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nosifer&display=swap">
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://3Dmol.org/build/3Dmol.ui-min.js"></script>
    <title>GRAVITy - Simulation Workspace</title>
</head>

<body>
    <div class="header">
        <ul class="nav">
            <li onclick="toggleDropdown(event)">File
                <ul class="dropdown" id="fileDropdown">
                    <li onclick="document.getElementById('fileInput').click()">Import File
                        <input type="file" id="fileInput" accept=".pdb" style="display: none;"
                            onchange="loadPDBFile(event)">
                    </li>
                    <li onclick="openModal()">Get with PDB ID
                    </li>
                </ul>
            </li>
            <li>Edit</li>
            <li>Tutorials</li>
            <li>Help</li>
        </ul>
    </div>
    <div class="container">
        <div class="column left" contenteditable="false">
            <div class="resizer"></div>
        </div>
        <div class="column right" contenteditable="false">
            <div class="logo-label">
                <span class="w3-jumbo nosifer-regular">G R A V </span>
                <img class="alpha_img" src="../static/images/barrel.png"></img>
                <span class="w3-jumbo nosifer-regular">T y</span>
            </div>
            <div id="viewer">
                <!-- <div style="height: 100%; width: 100%; position: relative;" class='viewer_3Dmoljs' data-pdb='pdbID' data-backgroundcolor='000' data-style='cartoon:color=spectrum' data-surface='opacity:.5;color:white' ></div> -->
            </div>
        </div>
    </div>
    <div id="pdbModal" class="modal">
        <div class="modal-header">Fetch Protein Structure <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="form-row">
            <label for="pdb_id">Enter PDB ID</label>
            <div class="input-container">
                <input type="text" id="pdbInput" name="pdb_id" placeholder="1SMD" required>
                <span class="tooltip">?
                    <span class="tooltiptext">Input PDB ID for Protein</span>
                </span>
            </div>
        </div>
        <button class="fetchBtn" onclick="fetchPDB()">Fetch</button>
    </div>
    <script>
        const leftColumn = document.querySelector('.left');
        const resizer = document.querySelector('.resizer');
        const dropdown = document.getElementById("fileDropdown");

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            let newWidth = e.clientX / window.innerWidth * 100;
            if (newWidth >= 20 && newWidth <= 50) {
                leftColumn.style.width = newWidth + '%';
            }
        }

        function stopResize() {
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

        function importFile() {
            alert("Import File function triggered");
            // Add file import functionality here
        }

        function loadPDBFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    viewer.clear();
                    viewer.addModel(e.target.result, "pdb");
                    viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
                    viewer.zoomTo();
                    viewer.render();
                };
                reader.readAsText(file);
            }
        }

        function toggleDropdown(event) {
            event.stopPropagation();
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        document.addEventListener("click", function (event) {
            if (!event.target.closest(".nav li")) {
                dropdown.style.display = "none";
            }
        });

        let viewer = $3Dmol.createViewer("viewer", { backgroundColor: "black" });
        function openModal() {
            let modal = document.getElementById("pdbModal");
            modal.style.display = "block";
            modal.style.top = "50%";
            modal.style.left = "50%";
            modal.style.transform = "translate(-50%, -50%)";
        }
        function closeModal() {
            document.getElementById("pdbModal").style.display = "none";
        }
        function fetchPDB() {
            let pdbId = document.getElementById("pdbInput").value.trim();
            if (!pdbId) {
                alert("Please enter a valid PDB ID");
                return;
            }
            console.log(`Fetching PDB ID: ${pdbId}`);

            fetch(`https://files.rcsb.org/download/${pdbId}.pdb`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch PDB file.");
                    }
                    return response.text();
                })
                .then(pdbData => {
                    viewer.clear();
                    viewer.addModel(pdbData, "pdb");  // Corrected function
                    viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
                    viewer.zoomTo();
                    viewer.render();
                    console.log("PDB model loaded successfully.");
                    closeModal();
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to load PDB file. Please check the ID.");
                });
        }
        let modal = document.getElementById("pdbModal");
        let offsetX, offsetY, isDragging = false;
        modal.addEventListener("mousedown", function (e) {
            isDragging = true;
            offsetX = e.clientX - modal.offsetLeft;
            offsetY = e.clientY - modal.offsetTop;
        });
        document.addEventListener("mousemove", function (e) {
            if (isDragging) {
                modal.style.left = (e.clientX - offsetX) + "px";
                modal.style.top = (e.clientY - offsetY) + "px";
            }
        });
        document.addEventListener("mouseup", function () {
            isDragging = false;
        });
        // // Initialize 3Dmol.js Viewer
        // let viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
        // viewer.addModel("3j8y", "pdb"); // Example PDB file
        // viewer.setStyle({}, {cartoon: {color: 'spectrum'}});
        // viewer.zoomTo();
        // viewer.render();
    </script>
</body>

</html>